var ModularityInteractiveMap=ModularityInteractiveMap||{};ModularityInteractiveMap.MapImage=function(e){function t(){this.handleEvents(),1==e('[name="interactive-map-is-selected"]').val()&&(this.mapSelected(),e(document).ready(function(){e("#map-layers li").each(function(){var t=e(this).attr("data-layer-id"),a=e(this).attr("data-layer-category");t&&e(this).append(ModularityInteractiveMap.MapPinCategories.getMultiSelector("interactive-map-layers["+t+"][category]",a,null))})}))}var a;return t.prototype.handleEvents=function(){e('[data-action="interactive-map-add-layer"]').on("click",function(e){e.preventDefault(),this.openMediaModal()}.bind(this)),e('[data-action="interactive-map-remove-image"]').on("click",function(e){e.preventDefault(),this.removeMap()}.bind(this))},t.prototype.openMediaModal=function(t){return a?(a.open(),void e(".media-router a:first-of-type").trigger("click")):void this.setupMediaModal()},t.prototype.setupMediaModal=function(){a=wp.media({title:"Map image",button:{text:"Select"},multiple:!1}),a.on("select",function(){var e=a.state().get("selection").first().toJSON();"undefined"!=typeof e&&this.mapSelected(e)}.bind(this)),this.openMediaModal()},t.prototype.mapSelected=function(t){e("[data-map-editor-no-map]").hide(),e("[data-map-editor]").show(),"undefined"!=typeof t&&(e("#map-image .map-container").append('<img src="'+t.url+'">'),e(".no-map").remove(),e("#map-layers").append('<li data-layer-id="'+t.id+'">                <input type="hidden" name="interactive-map-layers['+t.id+'][id]" value="'+t.id+'">                <input type="text" name="interactive-map-layers['+t.id+'][name]" value="'+t.title+'">                '+ModularityInteractiveMap.MapPinCategories.getMultiSelector("interactive-map-layers["+t.id+"][category]",null,null)+"            </li>"))},t.prototype.removeMap=function(){e("[data-map-editor-no-map]").show(),e("[data-map-editor]").hide(),e("#map-image .map-container img").remove(),e('[name="interactive-map-image-id"]').val("")},new t}(jQuery);var ModularityInteractiveMap=ModularityInteractiveMap||{};ModularityInteractiveMap.MapPinCategories=function(e){function t(){this.handleEvents()}var a=0,i=0;return t.prototype.handleEvents=function(){e('[data-action="interactive-map-add-pin-category"]').on("click",function(e){e.preventDefault(),this.addCategory()}.bind(this)),e(document).on("click",'[data-action="interactive-map-add-remove-category"]',function(t){t.preventDefault();var a=e(t.target).closest('[data-action="interactive-map-add-remove-category"]');this.removeCategory(a.attr("data-category-name"))}.bind(this)),e(document).on("change",".map-pin [data-map-category-selector]",function(t){var a=e(this).parents(".map-pin"),i=e(this).find("option:selected").attr("data-color");a.css("backgroundColor",i)})},t.prototype.getSelector=function(t,a,i){"undefined"==typeof a&&(a=null),"undefined"==typeof i&&(i="widefat");var n=this.getAll("numeric"),o=e('<select class="'+i+'" name="'+t+'" data-map-category-selector></select>');return o.append('<option value="" selected>-</option>'),e.each(n,function(e,t){return t.name===a?void o.append('<option style="color:'+t.color+';" value="'+t.name+'" data-color="'+t.color+'" selected>'+t.name+"</option>"):void o.append('<option style="color:'+t.color+';" value="'+t.name+'" data-color="'+t.color+'">'+t.name+"</option>")}.bind(this)),o[0].outerHTML},t.prototype.getMultiSelector=function(t,a){i++,a=a.split("|"),"undefined"==typeof a&&(a=null);var n=this.getAll("numeric"),o=e('<div class="ms-wrapper"><input class="ms-toggle" type="checkbox" id="dropdownopen-'+i+'"><label class="ms-placeholder" for="dropdownopen-'+i+'">Välj kategorier</label></div>'),p=e('<div class="ms-options"></div>');return e.each(n,function(e,i){return a.indexOf(i.name)>-1?void p.append('<label><input type="checkbox" name="'+t+'[]" value="'+i.name+'" checked> '+i.name+"</label>"):void p.append('<label><input type="checkbox" name="'+t+'[]" value="'+i.name+'"> '+i.name+"</label>")}.bind(this)),o.append(p),o[0].outerHTML},t.prototype.updateSelectors=function(t,a){e("[data-map-category-selector]").append('<option style="color:'+a+';" value="'+t+'" data-color="'+a+'">'+t+"</option>")},t.prototype.getAll=function(t){"undefined"==typeof t&&(t="name");var a=[],i=e(".interactive-map-categories-list li");return i.each(function(i,n){var o=e(this).find("[data-map-category]").val(),p=e(this).find("[data-map-category-color]").val(),r=[];r.name=o,r.color=p,"numeric"===t?a.push(r):a[o]=r}),a},t.prototype.addCategory=function(t,i){0===a&&(a=e(".interactive-map-categories-list li").length),a++,"undefined"==typeof t&&(t=e('[name="map-category-name"]').val()),"undefined"==typeof i&&(i=e('[name="map-category-pin-color"]').val()),i||(i="#FF0000");var n=[];return e("[data-map-category]").each(function(){n.push(e(this).val())}),n.indexOf(t)>-1?void alert("Category name must be unique"):(e(".interactive-map-categories-list").append('            <li data-category="'+t+'">                <span style="color:'+i+';">'+t+'</span>                <button type="button" class="button button-link" data-action="interactive-map-add-remove-category" data-category-name="'+t+'"><i class="fa fa-trash"></i></button>                                <input type="hidden" name="interactive-map-categories['+a+'][name]" value="'+t+'" data-map-category>                <input type="hidden" name="interactive-map-categories['+a+'][color]" value="'+i+'" data-map-category-color>            </li>        '),void this.updateSelectors(t,i))},t.prototype.removeCategory=function(t){e('.interactive-map-categories-list li[data-category="'+t+'"]').remove(),e('[data-map-category-selector] option[value="'+t+'"]').remove()},new t}(jQuery);var ModularityInteractiveMap=ModularityInteractiveMap||{};ModularityInteractiveMap.MapPins=function(e){function t(){e('[data-action="interactive-map-add-pin"]').on("click",function(e){e.preventDefault(),this.addPin()}.bind(this)),e(document).on("click",".map-pin",function(t){t.preventDefault(),e(t.target).closest('[data-action="interactive-map-pin-close"]').length||this.showPin(t.target)}.bind(this)),e(document).on("click",function(t){e(t.target).closest(".map-pin").length||this.hidePins()}.bind(this)),e(document).on("click",'[data-action="interactive-map-pin-close"]',function(e){e.preventDefault(),this.hidePins()}.bind(this)),e(document).on("click",'[data-action="interactive-map-pin-remove"]',function(e){this.removePin(e.target)}.bind(this))}var a,i=0;return t.prototype.addPin=function(t,n,o,p,r,c){a||(a=ModularityInteractiveMap.MapPinCategories.getAll()),"undefined"==typeof c&&(c=""),0===i&&(i=e("#map-image .map-container .map-pin").length),i++,"undefined"==typeof t&&(t=0),"undefined"==typeof n&&(n=0),"undefined"==typeof o&&(o=""),"undefined"==typeof p&&(p=""),"undefined"==typeof r&&(r="");var d="";c&&(d="background-color:"+a[c].color+";");var l=e('            <div class="map-pin" data-pin-id="'+i+'" style="position: absolute;top: '+t+";left: "+n+";"+d+'">                <div class="map-pin-popup">                    <input type="text" name="interactive-map-pin['+i+'][title]" class="widefat" placeholder="'+ModInteractiveMapLang.title+'…" value="'+o+'">                    <input type="text" name="interactive-map-pin['+i+'][link]" class="widefat" placeholder="'+ModInteractiveMapLang.link+'…" value="'+p+'">                    <textarea name="interactive-map-pin['+i+'][text]" class="widefat" placeholder="'+ModInteractiveMapLang.description+'…">'+r+"</textarea>                    "+ModularityInteractiveMap.MapPinCategories.getSelector("interactive-map-pin["+i+"][category]",c)+'                    <div class="pin-actions">                        <button class="button button-link" type="button" data-action="interactive-map-pin-remove">'+ModInteractiveMapLang.remove+'</button>                        <button class="button" type="button" data-action="interactive-map-pin-close">'+ModInteractiveMapLang.close+'</button>                    </div>                </div>                                <input type="hidden" name="interactive-map-pin['+i+'][top]" value="'+t+'" data-map-pin-top>                <input type="hidden" name="interactive-map-pin['+i+'][left]" value="'+n+'" data-map-pin-left>            </div>        ');l.draggable({containment:"parent",start:function(){ModularityInteractiveMap.MapPins.hidePins()},stop:function(t,a){e(this).find("[data-map-pin-top]").val(parseInt(e(this).css("top"))/(e("#map-image .map-container").height()/100)+"%"),e(this).find("[data-map-pin-left]").val(parseInt(e(this).css("left"))/(e("#map-image .map-container").width()/100)+"%")}}),l.appendTo("#map-image .map-container")},t.prototype.showPin=function(t){this.hidePins();var a=e(t).closest(".map-pin");a.find(".map-pin-popup").show()},t.prototype.hidePin=function(t){var a=e(t).closest(".map-pin");a.find(".map-pin-popup").hide()},t.prototype.hidePins=function(){e(".map-pin-popup").hide()},t.prototype.removePin=function(t){e(t).closest('[data-action="interactive-map-pin-remove"]').parents(".map-pin").remove()},new t}(jQuery);